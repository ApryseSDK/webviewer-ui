(self.webpackChunkwebviewer_ui=self.webpackChunkwebviewer_ui||[]).push([[7882],{"./src/helpers/downloadPdf.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{A:()=>__WEBPACK_DEFAULT_EXPORT__});var file_saver__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/file-saver/dist/FileSaver.min.js"),core__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./src/core/index.js"),helpers_device__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./src/helpers/device.js"),helpers_fireEvent__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("./src/helpers/fireEvent.js"),constants_events__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("./src/constants/events.js"),actions__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("./src/redux/actions/index.js"),helpers_rasterPrint__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("./src/helpers/rasterPrint.js"),selectors__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__("./src/redux/selectors/index.js"),blob_stream__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__("./node_modules/blob-stream/index.js"),blob_stream__WEBPACK_IMPORTED_MODULE_8___default=__webpack_require__.n(blob_stream__WEBPACK_IMPORTED_MODULE_8__),constants_sortStrategies__WEBPACK_IMPORTED_MODULE_9__=__webpack_require__("./src/constants/sortStrategies.js"),constants_map__WEBPACK_IMPORTED_MODULE_10__=__webpack_require__("./src/constants/map.js"),lodash_range__WEBPACK_IMPORTED_MODULE_11__=__webpack_require__("./node_modules/lodash/range.js"),lodash_range__WEBPACK_IMPORTED_MODULE_11___default=__webpack_require__.n(lodash_range__WEBPACK_IMPORTED_MODULE_11__),helpers_getRootNode__WEBPACK_IMPORTED_MODULE_16__=__webpack_require__("./src/helpers/getRootNode.js"),constants_types__WEBPACK_IMPORTED_MODULE_12__=__webpack_require__("./src/constants/types.js"),_officeEditor__WEBPACK_IMPORTED_MODULE_13__=__webpack_require__("./src/helpers/officeEditor.js"),src_constants_dataElement__WEBPACK_IMPORTED_MODULE_14__=__webpack_require__("./src/constants/dataElement.js"),constants_commonColors__WEBPACK_IMPORTED_MODULE_15__=__webpack_require__("./src/constants/commonColors.js");function _array_like_to_array(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg),value=info.value}catch(error){return void reject(error)}info.done?resolve(value):Promise.resolve(value).then(_next,_throw)}function _async_to_generator(fn){return function(){var self=this,args=arguments;return new Promise((function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(void 0)}))}}function _define_property(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}function _instanceof(left,right){return null!=right&&"undefined"!=typeof Symbol&&right[Symbol.hasInstance]?!!right[Symbol.hasInstance](left):left instanceof right}function _object_spread(target){for(var i=1;i<arguments.length;i++){var source=null!=arguments[i]?arguments[i]:{},ownKeys=Object.keys(source);"function"==typeof Object.getOwnPropertySymbols&&(ownKeys=ownKeys.concat(Object.getOwnPropertySymbols(source).filter((function(sym){return Object.getOwnPropertyDescriptor(source,sym).enumerable})))),ownKeys.forEach((function(key){_define_property(target,key,source[key])}))}return target}function _object_spread_props(target,source){return source=null!=source?source:{},Object.getOwnPropertyDescriptors?Object.defineProperties(target,Object.getOwnPropertyDescriptors(source)):function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);enumerableOnly&&(symbols=symbols.filter((function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable}))),keys.push.apply(keys,symbols)}return keys}(Object(source)).forEach((function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key))})),target}function _sliced_to_array(arr,i){return function _array_with_holes(arr){if(Array.isArray(arr))return arr}(arr)||function _iterable_to_array_limit(arr,i){var _i=null==arr?null:"undefined"!=typeof Symbol&&arr[Symbol.iterator]||arr["@@iterator"];if(null!=_i){var _s,_e,_arr=[],_n=!0,_d=!1;try{for(_i=_i.call(arr);!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{_n||null==_i.return||_i.return()}finally{if(_d)throw _e}}return _arr}}(arr,i)||_unsupported_iterable_to_array(arr,i)||function _non_iterable_rest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _to_consumable_array(arr){return function _array_without_holes(arr){if(Array.isArray(arr))return _array_like_to_array(arr)}(arr)||function _iterable_to_array(iter){if("undefined"!=typeof Symbol&&null!=iter[Symbol.iterator]||null!=iter["@@iterator"])return Array.from(iter)}(arr)||_unsupported_iterable_to_array(arr)||function _non_iterable_spread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _unsupported_iterable_to_array(o,minLen){if(o){if("string"==typeof o)return _array_like_to_array(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);return"Object"===n&&o.constructor&&(n=o.constructor.name),"Map"===n||"Set"===n?Array.from(n):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_array_like_to_array(o,minLen):void 0}}function _ts_generator(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function step(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=_.trys,(t=t.length>0&&t[t.length-1])||6!==op[0]&&2!==op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}}function _ts_values(o){var s="function"==typeof Symbol&&Symbol.iterator,m=s&&o[s],i=0;if(m)return m.call(o);if(o&&"number"==typeof o.length)return{next:function(){return o&&i>=o.length&&(o=void 0),{value:o&&o[i++],done:!o}}};throw new TypeError(s?"Object is not iterable.":"Symbol.iterator is not defined.")}const __WEBPACK_DEFAULT_EXPORT__=(_ref=_async_to_generator((function(dispatch){var options,documentViewerKey,doc,_options_filename,filename,_options_includeAnnotations,includeAnnotations,externalURL,_options_useDisplayAuthor,useDisplayAuthor,store,pages,includeComments,downloadAllPages,downloadDataAsFile,downloadAsImage,state,_ref,sortStrategy,dateFormat,language,printQuality,colorMap,id,style,printingOptions,createdPages,addWhiteBackground,html2canvas,_iteratorNormalCompletion,_didIteratorError,_iteratorError,_iterator,_step,page,dataURL,canvas,link,annotationsPromise,convertToPDF,data,xfdfString,fileData,canvas2pdf,state1,_ref1,sortStrategy1,colorMap1,pageWidth,pageHeight,titleFontSize,bodyFontSize,cardSpacing,padding,commentPages,_iteratorNormalCompletion1,_didIteratorError1,_iteratorError1,_loop,_iterator1,_step1,pageOffset,_iteratorNormalCompletion2,_didIteratorError2,_iteratorError2,_iterator2,_step2,page1,_iteratorNormalCompletion3,_didIteratorError3,_iteratorError3,_iterator3,_step3,blob,tempDoc,err,_,_1,_arguments=arguments;return _ts_generator(this,(function(_state){switch(_state.label){case 0:return options=_arguments.length>1&&void 0!==_arguments[1]?_arguments[1]:{},documentViewerKey=_arguments.length>2&&void 0!==_arguments[2]?_arguments[2]:1,doc=core__WEBPACK_IMPORTED_MODULE_1__.A.getDocument(documentViewerKey),_options_filename=options.filename,filename=void 0===_options_filename?(null==doc?void 0:doc.getFilename())||"document":_options_filename,_options_includeAnnotations=options.includeAnnotations,includeAnnotations=void 0===_options_includeAnnotations||_options_includeAnnotations,externalURL=options.externalURL,_options_useDisplayAuthor=options.useDisplayAuthor,useDisplayAuthor=void 0!==_options_useDisplayAuthor&&_options_useDisplayAuthor,store=options.store,pages=options.pages,includeComments=!!options.includeComments,downloadAllPages=!pages||pages.length===doc.getPageCount(),downloadDataAsFile=function(data,extension,options){var file,arr=new Uint8Array(data),downloadName=options.downloadName,downloadType="application/pdf";"office"===options.downloadType&&(downloadType=function reverseObject(obj){var _Object;return(_Object=Object).assign.apply(_Object,[{}].concat(_to_consumable_array(Object.entries(obj).map((function(param){var _param=_sliced_to_array(param,2),key=_param[0];return _define_property({},_param[1],key)})))))}(window.Core.mimeTypeToExtension)[extension]),file=helpers_device__WEBPACK_IMPORTED_MODULE_2__.lT?new Blob([arr],{type:downloadType}):new File([arr],filename,{type:downloadType}),(0,file_saver__WEBPACK_IMPORTED_MODULE_0__.saveAs)(file,downloadName||filename),dispatch(actions__WEBPACK_IMPORTED_MODULE_5__.A.closeElement(src_constants_dataElement__WEBPACK_IMPORTED_MODULE_14__.A.LOADING_MODAL)),(0,helpers_fireEvent__WEBPACK_IMPORTED_MODULE_3__.A)(constants_events__WEBPACK_IMPORTED_MODULE_4__.A.FILE_DOWNLOADED),(includeComments||convertToPDF)&&doc.unloadResources()},(0,_officeEditor__WEBPACK_IMPORTED_MODULE_13__.p)()&&(includeComments=!1),options.downloadType||(options.downloadType="pdf"),downloadAsImage="png"===options.downloadType,dispatch(actions__WEBPACK_IMPORTED_MODULE_5__.A.openElement(src_constants_dataElement__WEBPACK_IMPORTED_MODULE_14__.A.LOADING_MODAL)),downloadAsImage?((null==pages?void 0:pages.length)||(pages=lodash_range__WEBPACK_IMPORTED_MODULE_11___default()(1,doc.getPageCount()+1,1)),state=store.getState(),_ref=[selectors__WEBPACK_IMPORTED_MODULE_7__.A.getSortStrategy(state),selectors__WEBPACK_IMPORTED_MODULE_7__.A.getPrintedNoteDateFormat(state),selectors__WEBPACK_IMPORTED_MODULE_7__.A.getCurrentLanguage(state),selectors__WEBPACK_IMPORTED_MODULE_7__.A.getPrintQuality(state),selectors__WEBPACK_IMPORTED_MODULE_7__.A.getColorMap(state)],sortStrategy=_ref[0],dateFormat=_ref[1],language=_ref[2],printQuality=_ref[3],colorMap=_ref[4],id="download-handler-css",(0,helpers_getRootNode__WEBPACK_IMPORTED_MODULE_16__.Ay)().querySelector("#".concat(id))||((style=window.document.createElement("style")).id=id,style.textContent="\n        img {\n          display: block !important;\n          max-width: 100%;\n          max-height: 100%;\n          height: 100%;\n          width: 100%;\n          object-fit: contain;\n          page-break-after: always;\n          padding: 0;\n          margin: 0;\n        }\n\n        .page__container {\n          margin: 10px;\n          box-sizing: border-box;\n          display: flex !important;\n          flex-direction: column;\n          padding: 10px;\n          min-height: 100%;\n          min-width: 100%;\n          font-size: 10px;\n        }\n\n        .page__container .page__header {\n          margin-top: 2rem;\n          display: block !important;\n          align-self: flex-start;\n          font-size: 2rem;\n          margin-bottom: 2rem;\n          padding-bottom: 0.6rem;\n          border-bottom: 0.1rem solid black;\n        }\n\n        .page__container .note {\n          display: flex !important;\n          flex-direction: column;\n          padding: 0.6rem;\n          border: 0.1rem lightgray solid;\n          border-radius: 0.4rem;\n          margin-bottom: 0.5rem;\n        }\n\n        .page__container .note .note__info {\n          display: block !important;\n          font-size: 1.3rem;\n          margin-bottom: 0.1rem;\n        }\n\n        .page__container .note .note__info--with-icon {\n          display: flex !important;\n        }\n\n        .page__container .note .note__info--with-icon .note__icon {\n          display: block !important;\n          width: 1.65rem;\n          height: 1.65rem;\n          margin-top: -0.1rem;\n          margin-right: 0.2rem;\n        }\n\n        .page__container .note .note__info--with-icon .note__icon path:not([fill=none]) {\n          display: block !important;\n          fill: currentColor;\n        }\n\n        .page__container .note .note__root .note__content {\n          display: block !important;\n          margin-left: 0.3rem;\n        }\n\n        .page__container .note .note__root {\n          display: block !important;\n        }\n\n        .page__container .note .note__info--with-icon .note__icon svg {\n          display: block !important;\n        }\n\n        .page__container .note .note__reply {\n          display: block !important;\n          margin: 0.5rem 0 0 2rem;\n        }\n\n        .page__container .note .note__content {\n          display: block !important;\n          font-size: 1.2rem;\n          margin-top: 0.1rem;\n        }\n      ",window.document.head.prepend(style)),printingOptions={includeComments,includeAnnotations,maintainPageOrientation:!0,printQuality,sortStrategy,colorMap,dateFormat,isPrintCurrentView:!1,language,createCanvases:!0,isGrayscale:!1},createdPages=(0,helpers_rasterPrint__WEBPACK_IMPORTED_MODULE_6__.CB)(pages,printingOptions,void 0),addWhiteBackground=function(dataURL){var pagePrintCanvas=document.createElement("canvas"),pagePrintContext=pagePrintCanvas.getContext("2d");return new Promise((function(res){var printImg=new Image;printImg.src=dataURL,printImg.onload=function(){pagePrintCanvas.width=printImg.width,pagePrintCanvas.height=printImg.height,pagePrintContext.fillStyle=constants_commonColors__WEBPACK_IMPORTED_MODULE_15__.z.white,pagePrintContext.fillRect(0,0,pagePrintCanvas.width,pagePrintCanvas.height),pagePrintContext.drawImage(printImg,0,0),res(pagePrintCanvas.toDataURL())}}))},[4,__webpack_require__.e(6526).then(__webpack_require__.t.bind(__webpack_require__,"./node_modules/html2canvas/dist/npm/index.js",23))]):[3,16];case 1:html2canvas=_state.sent().default,_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0,_state.label=2;case 2:_state.trys.push([2,13,14,15]),_iterator=createdPages[Symbol.iterator](),_state.label=3;case 3:return(_iteratorNormalCompletion=(_step=_iterator.next()).done)?[3,12]:[4,page=_step.value];case 4:return page=_state.sent(),dataURL=void 0,_instanceof(page,HTMLElement)?(document.body.appendChild(page),[4,html2canvas(page,{backgroundColor:null,scale:1,logging:!1})]):[3,7];case 5:return canvas=_state.sent(),[4,addWhiteBackground(canvas.toDataURL())];case 6:return dataURL=_state.sent(),document.body.removeChild(page),[3,10];case 7:return(null==doc?void 0:doc.getType())!==constants_types__WEBPACK_IMPORTED_MODULE_12__._.OFFICE&&(null==doc?void 0:doc.getType())!==constants_types__WEBPACK_IMPORTED_MODULE_12__._.LEGACY_OFFICE&&(null==doc?void 0:doc.getType())!==constants_types__WEBPACK_IMPORTED_MODULE_12__._.OFFICE_EDITOR?[3,9]:[4,addWhiteBackground(page)];case 8:return dataURL=_state.sent(),[3,10];case 9:dataURL=page,_state.label=10;case 10:(link=document.createElement("a")).href=dataURL,link.download="".concat(filename,".png"),link.style.display="none",document.body.appendChild(link),link.click(),document.body.removeChild(link),_state.label=11;case 11:return _iteratorNormalCompletion=!0,[3,3];case 12:return[3,15];case 13:return err=_state.sent(),_didIteratorError=!0,_iteratorError=err,[3,15];case 14:try{_iteratorNormalCompletion||null==_iterator.return||_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}return[7];case 15:return dispatch(actions__WEBPACK_IMPORTED_MODULE_5__.A.closeElement(src_constants_dataElement__WEBPACK_IMPORTED_MODULE_14__.A.LOADING_MODAL)),(0,helpers_fireEvent__WEBPACK_IMPORTED_MODULE_3__.A)(constants_events__WEBPACK_IMPORTED_MODULE_4__.A.FILE_DOWNLOADED),[2];case 16:return annotationsPromise=Promise.resolve(),convertToPDF="pdf"===options.downloadType&&(doc.getType()===constants_types__WEBPACK_IMPORTED_MODULE_12__._.OFFICE||(0,_officeEditor__WEBPACK_IMPORTED_MODULE_13__.p)()),(0,_officeEditor__WEBPACK_IMPORTED_MODULE_13__.p)()&&convertToPDF?[4,doc.getFileData({downloadType:"pdf"})]:[3,18];case 17:return data=_state.sent(),downloadDataAsFile(data,"pdf",options),[2];case 18:return convertToPDF||includeComments?[4,core__WEBPACK_IMPORTED_MODULE_1__.A.exportAnnotations({fields:!0,widgets:!0,links:!0,useDisplayAuthor},documentViewerKey)]:[3,49];case 19:return xfdfString=_state.sent(),[4,doc.getFileData({xfdfString,includeAnnotations,downloadType:"pdf"})];case 20:return fileData=_state.sent(),[4,core__WEBPACK_IMPORTED_MODULE_1__.A.createDocument(fileData,{extension:"pdf",filename})];case 21:return doc=_state.sent(),includeComments?[4,Promise.all([__webpack_require__.e(4373),__webpack_require__.e(4118)]).then(__webpack_require__.t.bind(__webpack_require__,"./node_modules/canvas2pdf/canvas2pdf.js",23))]:[3,47];case 22:canvas2pdf=_state.sent(),state1=store.getState(),_ref1=[selectors__WEBPACK_IMPORTED_MODULE_7__.A.getSortStrategy(state1),selectors__WEBPACK_IMPORTED_MODULE_7__.A.getColorMap(state1)],sortStrategy1=_ref1[0],colorMap1=_ref1[1],pageWidth=612,pageHeight=792,titleFontSize=12,bodyFontSize=11,cardSpacing=8,padding=36,commentPages={},_iteratorNormalCompletion1=!0,_didIteratorError1=!1,_iteratorError1=void 0,_state.label=23;case 23:_state.trys.push([23,28,29,30]),_loop=function(){var pageNumber,savePage,annotationNotes,startX,startY,ctx,x,y,text,textSize,_iteratorNormalCompletion,_didIteratorError,_iteratorError,_loop,_iterator,_step,err;function _savePage(){return _savePage=_async_to_generator((function(){var blob;return _ts_generator(this,(function(_state){switch(_state.label){case 0:return[4,new Promise((function(res){ctx.stream.on("finish",(function(){return res(ctx.stream.toBlob("application/pdf"))})),ctx.end()}))];case 1:return blob=_state.sent(),commentPages[pageNumber]?commentPages[pageNumber].push(blob):commentPages[pageNumber]=[blob],[2]}}))})),_savePage.apply(this,arguments)}return _ts_generator(this,(function(_state){switch(_state.label){case 0:if(pageNumber=_step1.value,savePage=function savePage(){return _savePage.apply(this,arguments)},!(null==(annotationNotes=(0,constants_sortStrategies__WEBPACK_IMPORTED_MODULE_9__.Qk)()[sortStrategy1].getSortedNotes(core__WEBPACK_IMPORTED_MODULE_1__.A.getAnnotationsList(documentViewerKey).filter((function(annotation){return annotation.Listable&&annotation.PageNumber===pageNumber&&!annotation.isReply()&&!annotation.isGrouped()}))))?void 0:annotationNotes.length))return[2,"continue"];startX=padding,startY=padding,ctx=new canvas2pdf.PdfContext(blob_stream__WEBPACK_IMPORTED_MODULE_8___default()(),{font:"Helvetica"}),x=startX,y=startY,text="Page ".concat(pageNumber),ctx.font="".concat(titleFontSize,"px Helvetica"),ctx.fillStyle=constants_commonColors__WEBPACK_IMPORTED_MODULE_15__.z.black,textSize=ctx.measureText(text),ctx.fillText(text,x,y),y+=textSize.height,_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0,_state.label=1;case 1:_state.trys.push([1,6,7,8]),_loop=function(){var annotation,drawAnnotationComment,skip,lastYPos,_iteratorNormalCompletion,_didIteratorError,_iteratorError,_iterator,_step1,reply,err;function _drawAnnotationComment(){return _drawAnnotationComment=_async_to_generator((function(annotation,startX){var isReply,date,subjectText,subjectTextSize,_arguments=arguments;function drawTextAndWrap(text){return _drawTextAndWrap.apply(this,arguments)}function _drawTextAndWrap(){return _drawTextAndWrap=_async_to_generator((function(text){var textArray,_iteratorNormalCompletion,_didIteratorError,_iteratorError,_iterator,_step,err,textSize,maxSize,indexOfLastSpaceToFit,_arguments=arguments;return _ts_generator(this,(function(_state){switch(_state.label){case 0:if(_arguments.length>1&&void 0!==_arguments[1]&&!_arguments[1])return[3,9];if(!((textArray=text.split("\n")).length>1))return[3,9];_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0,_state.label=1;case 1:_state.trys.push([1,6,7,8]),_iterator=textArray[Symbol.iterator](),_state.label=2;case 2:return(_iteratorNormalCompletion=(_step=_iterator.next()).done)?[3,5]:[4,drawTextAndWrap(_step.value,!1)];case 3:_state.sent(),x=startX,_state.label=4;case 4:return _iteratorNormalCompletion=!0,[3,2];case 5:return[3,8];case 6:return err=_state.sent(),_didIteratorError=!0,_iteratorError=err,[3,8];case 7:try{_iteratorNormalCompletion||null==_iterator.return||_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}return[7];case 8:return[2];case 9:return(textSize=ctx.measureText(text)).width+x>pageWidth-padding-cardSpacing?(maxSize=pageWidth-2*padding-3*cardSpacing,isReply&&(maxSize-=36),indexOfLastSpaceToFit=text.lastIndexOf(" ",text.length*maxSize/(textSize.width+x)),[4,drawText(text.substring(0,indexOfLastSpaceToFit),{x,y})]):[3,12];case 10:return extractProperties.apply(void 0,[_state.sent()]),y+=textSize.height,x=startX,[4,drawTextAndWrap(text.substring(indexOfLastSpaceToFit+1))];case 11:return _state.sent(),[3,13];case 12:ctx.fillText(text,x,y),y+=textSize.height,_state.label=13;case 13:return[2]}}))})),_drawTextAndWrap.apply(this,arguments)}function drawText(text){return _drawText.apply(this,arguments)}function _drawText(){return _drawText=_async_to_generator((function(text){var options,_options_bold,bold,_options_fillStyle,fillStyle,_options_size,size,_options_font,font,x,y,textSize,_arguments=arguments;return _ts_generator(this,(function(_state){switch(_state.label){case 0:return _options_bold=(options=_arguments.length>1&&void 0!==_arguments[1]?_arguments[1]:{}).bold,bold=void 0!==_options_bold&&_options_bold,_options_fillStyle=options.fillStyle,fillStyle=void 0===_options_fillStyle?constants_commonColors__WEBPACK_IMPORTED_MODULE_15__.z.black:_options_fillStyle,_options_size=options.size,size=void 0===_options_size?bodyFontSize:_options_size,_options_font=options.font,font=void 0===_options_font?"Helvetica":_options_font,x=options.x,y=options.y,ctx.fillStyle=fillStyle,ctx.font="".concat(size,"px ").concat(font),(textSize=ctx.measureText(text)).height+y>pageHeight-padding?(drawRoundedRect(ctx,padding,startY,pageWidth-2*padding,pageHeight-startY-padding,4,"bottom"),[4,savePage()]):[3,2];case 1:_state.sent(),(ctx=new canvas2pdf.PdfContext(blob_stream__WEBPACK_IMPORTED_MODULE_8___default()(),{font:"Helvetica"})).fillStyle=fillStyle,ctx.font="".concat(size,"px ").concat(font),x=startX,y=padding+cardSpacing,startY=padding,skip="top",_state.label=2;case 2:return ctx.fillText(text,x,y),bold&&(ctx.fillText(text,x+.1,y),textSize.width+=.1),[2,{textSize,x,y,startY}]}}))})),_drawText.apply(this,arguments)}function extractProperties(newProperties){x=newProperties.x,y=newProperties.y,startY=newProperties.startY,textSize=newProperties.textSize}return _ts_generator(this,(function(_state){switch(_state.label){case 0:return isReply=_arguments.length>2&&void 0!==_arguments[2]&&_arguments[2],[4,drawText(annotation.Author||"Guest",{bold:!0,x,y})];case 1:return extractProperties.apply(void 0,[_state.sent()]),x+=textSize.width+cardSpacing,date=new Date(annotation.DateCreated),[4,drawText("- ".concat(date.toLocaleString(void 0,{month:"short",day:"numeric",year:"numeric",hour:"numeric",minute:"numeric"})),{fillStyle:constants_commonColors__WEBPACK_IMPORTED_MODULE_15__.z.gray8,x,y})];case 2:return extractProperties.apply(void 0,[_state.sent()]),x+=textSize.width+cardSpacing,isReply||(subjectText="Subject: ".concat(annotation.Subject),(subjectTextSize=ctx.measureText(subjectText)).width<90&&(subjectTextSize.width=90),ctx.fillText(subjectText,pageWidth-padding-subjectTextSize.width-cardSpacing,y)),x=startX,y+=textSize.height+cardSpacing,isReply||(y+=cardSpacing),ctx.fillStyle=constants_commonColors__WEBPACK_IMPORTED_MODULE_15__.z.black,annotation.getContents()?[4,drawTextAndWrap(annotation.getContents())]:[3,4];case 3:return _state.sent(),y+=cardSpacing,[3,5];case 4:y-=cardSpacing,_state.label=5;case 5:return[2,y-cardSpacing]}}))})),_drawAnnotationComment.apply(this,arguments)}return _ts_generator(this,(function(_state){switch(_state.label){case 0:return annotation=_step.value,drawAnnotationComment=function drawAnnotationComment(annotation,startX){return _drawAnnotationComment.apply(this,arguments)},y+40>pageHeight?[4,savePage()]:[3,2];case 1:_state.sent(),ctx=new canvas2pdf.PdfContext(blob_stream__WEBPACK_IMPORTED_MODULE_8___default()(),{font:"Helvetica"}),x=padding,y=padding,_state.label=2;case 2:return startY=y+=cardSpacing,y+=cardSpacing,x+=cardSpacing,skip=void 0,[4,new Promise((function(resolve){var key=(0,constants_map__WEBPACK_IMPORTED_MODULE_10__.c7)(annotation),colorProperty=colorMap1[key]&&colorMap1[key].iconColor,color=annotation[colorProperty||"StrokeColor"].toString(),iconKey=(0,constants_map__WEBPACK_IMPORTED_MODULE_10__.ap)(key).icon,icon=__webpack_require__("./assets/icons sync recursive ^\\.\\/.*\\.svg$")("./".concat(iconKey,".svg")),blob=new Blob([icon],{type:"image/svg+xml;charset=utf-8"}),url=URL.createObjectURL(blob),img=new Image;img.style.color=color,img.src=url,img.onload=function(){ctx.drawImage(img,x,y,24,24),URL.revokeObjectURL(url),resolve()}}))];case 3:return _state.sent(),y+=14,[4,drawAnnotationComment(annotation,(x+=30)-30)];case 4:lastYPos=_state.sent(),x=startX+36,_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0,_state.label=5;case 5:_state.trys.push([5,10,11,12]),_iterator=annotation.getReplies()[Symbol.iterator](),_state.label=6;case 6:return(_iteratorNormalCompletion=(_step1=_iterator.next()).done)?[3,9]:(reply=_step1.value,y+=cardSpacing,[4,drawAnnotationComment(reply,x,!0)]);case 7:lastYPos=_state.sent(),_state.label=8;case 8:return _iteratorNormalCompletion=!0,[3,6];case 9:return[3,12];case 10:return err=_state.sent(),_didIteratorError=!0,_iteratorError=err,[3,12];case 11:try{_iteratorNormalCompletion||null==_iterator.return||_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}return[7];case 12:return drawRoundedRect(ctx,padding,startY,pageWidth-2*padding,lastYPos-startY+cardSpacing,4,skip),x=startX,[2]}}))},_iterator=annotationNotes[Symbol.iterator](),_state.label=2;case 2:return(_iteratorNormalCompletion=(_step=_iterator.next()).done)?[3,5]:[5,_ts_values(_loop())];case 3:_state.sent(),_state.label=4;case 4:return _iteratorNormalCompletion=!0,[3,2];case 5:return[3,8];case 6:return err=_state.sent(),_didIteratorError=!0,_iteratorError=err,[3,8];case 7:try{_iteratorNormalCompletion||null==_iterator.return||_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}return[7];case 8:return[4,savePage()];case 9:return _state.sent(),[2]}}))},_iterator1=pages[Symbol.iterator](),_state.label=24;case 24:return(_iteratorNormalCompletion1=(_step1=_iterator1.next()).done)?[3,27]:[5,_ts_values(_loop())];case 25:_state.sent(),_state.label=26;case 26:return _iteratorNormalCompletion1=!0,[3,24];case 27:return[3,30];case 28:return err=_state.sent(),_didIteratorError1=!0,_iteratorError1=err,[3,30];case 29:try{_iteratorNormalCompletion1||null==_iterator1.return||_iterator1.return()}finally{if(_didIteratorError1)throw _iteratorError1}return[7];case 30:pageOffset=1,_iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0,_state.label=31;case 31:_state.trys.push([31,43,44,45]),_iterator2=Object.keys(commentPages)[Symbol.iterator](),_state.label=32;case 32:if(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done)return[3,42];page1=_step2.value,page1=parseInt(page1),_iteratorNormalCompletion3=!0,_didIteratorError3=!1,_iteratorError3=void 0,_state.label=33;case 33:_state.trys.push([33,39,40,41]),_iterator3=commentPages[page1][Symbol.iterator](),_state.label=34;case 34:return(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done)?[3,38]:(blob=_step3.value,[4,core__WEBPACK_IMPORTED_MODULE_1__.A.createDocument(blob,{extension:"pdf"})]);case 35:return tempDoc=_state.sent(),[4,doc.insertPages(tempDoc,[1],page1+pageOffset)];case 36:_state.sent(),downloadAllPages||(pages=pages.map((function(p){return p>=page1+pageOffset?p+1:p}))).push(page1+pageOffset),pageOffset++,tempDoc.unloadResources(),_state.label=37;case 37:return _iteratorNormalCompletion3=!0,[3,34];case 38:return[3,41];case 39:return err=_state.sent(),_didIteratorError3=!0,_iteratorError3=err,[3,41];case 40:try{_iteratorNormalCompletion3||null==_iterator3.return||_iterator3.return()}finally{if(_didIteratorError3)throw _iteratorError3}return[7];case 41:return _iteratorNormalCompletion2=!0,[3,32];case 42:return[3,45];case 43:return err=_state.sent(),_didIteratorError2=!0,_iteratorError2=err,[3,45];case 44:try{_iteratorNormalCompletion2||null==_iterator2.return||_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}return[7];case 45:return pages=downloadAllPages?void 0:pages.sort((function(a,b){return a-b})),_=Promise.resolve,[4,doc.extractXFDF({pages})];case 46:return annotationsPromise=_.apply(Promise,[_state.sent().xfdfString]),[3,48];case 47:annotationsPromise=Promise.resolve(xfdfString),_state.label=48;case 48:return[3,54];case 49:return!includeAnnotations||options.xfdfString||downloadAsImage?[3,53]:options.documentToBeDownloaded?(_1=Promise.resolve,[4,options.documentToBeDownloaded.extractXFDF(pages)]):[3,51];case 50:return annotationsPromise=_1.apply(Promise,[_state.sent().xfdfString]),[3,52];case 51:annotationsPromise=core__WEBPACK_IMPORTED_MODULE_1__.A.exportAnnotations({useDisplayAuthor},documentViewerKey),_state.label=52;case 52:return[3,54];case 53:options.xfdfString||includeAnnotations||(options.xfdfString=window.Core.EMPTY_XFDF),_state.label=54;case 54:return[2,annotationsPromise.then(function(){var _ref=_async_to_generator((function(xfdfString){var getDownloadFilename,array,extension,isNotPDF,downloadName,clonedOptions,handleError,signatureWidgets,downloadIframe;return _ts_generator(this,(function(_state){switch(_state.label){case 0:return options.xfdfString=options.xfdfString||xfdfString,includeAnnotations||(options.includeAnnotations=!1),getDownloadFilename=function(name,extension){return name.slice(-extension.length).toLowerCase()!==extension&&(name+=extension),name},array=doc.getFilename().split("."),extension="".concat(array[array.length-1]),isNotPDF=(null==doc?void 0:doc.getType().includes("video"))||"audio"===(null==doc?void 0:doc.getType())||(null==doc?void 0:doc.getType())===constants_types__WEBPACK_IMPORTED_MODULE_12__._.OFFICE||(0,_officeEditor__WEBPACK_IMPORTED_MODULE_13__.p)(),downloadName=getDownloadFilename(filename,isNotPDF?".".concat(extension):".pdf"),(clonedOptions=Object.assign({},options)).documentToBeDownloaded&&(doc=clonedOptions.documentToBeDownloaded,delete clonedOptions.documentToBeDownloaded),clonedOptions.store&&delete clonedOptions.store,handleError=function(error){throw dispatch(actions__WEBPACK_IMPORTED_MODULE_5__.A.closeElement(src_constants_dataElement__WEBPACK_IMPORTED_MODULE_14__.A.LOADING_MODAL)),new Error(error.message)},signatureWidgets=core__WEBPACK_IMPORTED_MODULE_1__.A.getAnnotationsList().filter((function(a){return _instanceof(a,window.Core.Annotations.SignatureWidgetAnnotation)})),[4,Promise.all(signatureWidgets.map((function(a){return a.isSignedDigitally()})))];case 1:return _state.sent().includes(!0)&&(clonedOptions.flags|=window.Core.SaveOptions.INCREMENTAL),externalURL?((downloadIframe=(0,helpers_getRootNode__WEBPACK_IMPORTED_MODULE_16__.Ay)().querySelector("#download-iframe")||document.createElement("iframe")).width=0,downloadIframe.height=0,downloadIframe.id="download-iframe",downloadIframe.src=null,document.body.appendChild(downloadIframe),downloadIframe.src=externalURL,dispatch(actions__WEBPACK_IMPORTED_MODULE_5__.A.closeElement(src_constants_dataElement__WEBPACK_IMPORTED_MODULE_14__.A.LOADING_MODAL)),(0,helpers_fireEvent__WEBPACK_IMPORTED_MODULE_3__.A)(constants_events__WEBPACK_IMPORTED_MODULE_4__.A.FILE_DOWNLOADED),[2]):pages&&!downloadAllPages?[2,doc.extractPages(pages,options.xfdfString).then((function(data){return downloadDataAsFile(data,extension,_object_spread_props(_object_spread({},options),{downloadName}))}),handleError)]:[2,doc.getFileData(clonedOptions).then((function(data){return downloadDataAsFile(data,extension,_object_spread_props(_object_spread({},options),{downloadName}))}),handleError)]}}))}));return function(xfdfString){return _ref.apply(this,arguments)}}()).catch((function(error){console.warn(error),dispatch(actions__WEBPACK_IMPORTED_MODULE_5__.A.closeElement(src_constants_dataElement__WEBPACK_IMPORTED_MODULE_14__.A.LOADING_MODAL))}))]}}))})),function(dispatch){return _ref.apply(this,arguments)});var _ref;function drawRoundedRect(ctx,x,y,width,height,radius){var skip=arguments.length>6&&void 0!==arguments[6]?arguments[6]:void 0,skipTop="top"===skip,skipBottom="bottom"===skip;ctx.beginPath(),ctx.strokeStyle="lightgray",ctx.lineWidth=1,skipTop?(ctx.moveTo(x,y),ctx.lineTo(x,y+height-radius),ctx.quadraticCurveTo(x,y+height,x+radius,y+height),ctx.lineTo(x+width-radius,y+height),ctx.quadraticCurveTo(x+width,y+height,x+width,y+height-radius),ctx.lineTo(x+width,y)):skipBottom?(ctx.moveTo(x,y+height),ctx.lineTo(x,y+radius),ctx.quadraticCurveTo(x,y,x+radius,y),ctx.lineTo(x+width-radius,y),ctx.quadraticCurveTo(x+width,y,x+width,y+radius),ctx.lineTo(x+width,y+height)):(ctx.moveTo(x+radius,y),ctx.lineTo(x+width-radius,y),ctx.quadraticCurveTo(x+width,y,x+width,y+radius),ctx.lineTo(x+width,y+height-radius),ctx.quadraticCurveTo(x+width,y+height,x+width-radius,y+height),ctx.lineTo(x+radius,y+height),ctx.quadraticCurveTo(x,y+height,x,y+height-radius),ctx.lineTo(x,y+radius),ctx.quadraticCurveTo(x,y,x+radius,y),ctx.closePath()),ctx.stroke()}},"?c02f":()=>{}}]);