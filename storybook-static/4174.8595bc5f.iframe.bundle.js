"use strict";(self.webpackChunkwebviewer_ui=self.webpackChunkwebviewer_ui||[]).push([[4174],{"./src/helpers/TabManager.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{Ay:()=>TabManager,Cf:()=>enableMultiTab,IT:()=>prepareMultiTab});var core__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./src/core/index.js"),constants_types__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./src/constants/types.js"),helpers_loadDocument__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./src/helpers/loadDocument.js"),actions_internalActions__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("./src/redux/actions/internalActions.js"),actions__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("./src/redux/actions/index.js"),selectors__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("./src/redux/selectors/index.js"),helpers_getHashParameters__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("./src/helpers/getHashParameters.js"),helpers_fireEvent__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__("./src/helpers/fireEvent.js"),helpers_downloadPdf__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__("./src/helpers/downloadPdf.js"),constants_events__WEBPACK_IMPORTED_MODULE_9__=__webpack_require__("./src/constants/events.js"),lodash_isString__WEBPACK_IMPORTED_MODULE_10__=__webpack_require__("./node_modules/lodash/isString.js"),lodash_isString__WEBPACK_IMPORTED_MODULE_10___default=__webpack_require__.n(lodash_isString__WEBPACK_IMPORTED_MODULE_10__),constants_dataElement__WEBPACK_IMPORTED_MODULE_11__=__webpack_require__("./src/constants/dataElement.js"),helpers_getRootNode__WEBPACK_IMPORTED_MODULE_12__=__webpack_require__("./src/helpers/getRootNode.js");function _array_like_to_array(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg),value=info.value}catch(error){return void reject(error)}info.done?resolve(value):Promise.resolve(value).then(_next,_throw)}function _async_to_generator(fn){return function(){var self=this,args=arguments;return new Promise((function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(void 0)}))}}function _class_call_check(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function _create_class(Constructor,protoProps,staticProps){return protoProps&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Constructor}function _define_property(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}function _instanceof(left,right){return null!=right&&"undefined"!=typeof Symbol&&right[Symbol.hasInstance]?!!right[Symbol.hasInstance](left):left instanceof right}function _sliced_to_array(arr,i){return function _array_with_holes(arr){if(Array.isArray(arr))return arr}(arr)||function _iterable_to_array_limit(arr,i){var _i=null==arr?null:"undefined"!=typeof Symbol&&arr[Symbol.iterator]||arr["@@iterator"];if(null!=_i){var _s,_e,_arr=[],_n=!0,_d=!1;try{for(_i=_i.call(arr);!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{_n||null==_i.return||_i.return()}finally{if(_d)throw _e}}return _arr}}(arr,i)||function _unsupported_iterable_to_array(o,minLen){if(!o)return;if("string"==typeof o)return _array_like_to_array(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);"Object"===n&&o.constructor&&(n=o.constructor.name);if("Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _array_like_to_array(o,minLen)}(arr,i)||function _non_iterable_rest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _ts_generator(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function step(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=_.trys,(t=t.length>0&&t[t.length-1])||6!==op[0]&&2!==op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}}var enableMultiTab=function(){return function(dispatch,getState){var state=getState();if(!selectors__WEBPACK_IMPORTED_MODULE_5__.A.getIsMultiTab(state)||!selectors__WEBPACK_IMPORTED_MODULE_5__.A.getTabManager(state)){var doc=core__WEBPACK_IMPORTED_MODULE_0__.A.getDocument(),docArr=[];if(doc)docArr.push(doc);else{var initialDoc=(0,helpers_getHashParameters__WEBPACK_IMPORTED_MODULE_6__.A)("d","");(initialDoc=initialDoc?JSON.parse(initialDoc):"")&&(Array.isArray(initialDoc)?docArr=docArr.concat(initialDoc):docArr.push(initialDoc))}var tabManager=new TabManager(docArr,[],{dispatch,getState});dispatch(actions__WEBPACK_IMPORTED_MODULE_4__.A.setMultiTab(!0)),dispatch(actions__WEBPACK_IMPORTED_MODULE_4__.A.setTabManager(tabManager)),setTimeout((function(){(0,helpers_fireEvent__WEBPACK_IMPORTED_MODULE_7__.A)(constants_events__WEBPACK_IMPORTED_MODULE_9__.A.TAB_MANAGER_READY)}),300),core__WEBPACK_IMPORTED_MODULE_0__.A.addEventListener("documentLoaded",(function docLoadedEvent(){var doc=core__WEBPACK_IMPORTED_MODULE_0__.A.getDocument();selectors__WEBPACK_IMPORTED_MODULE_5__.A.getTabs(state).some((function(item){var _item_options;return(null===(_item_options=item.options)||void 0===_item_options?void 0:_item_options.filename)===doc.filename}))||doc.getFileData().then((function(data){try{tabManager.addTab(new File([data],doc.getFilename()))}catch(error){console.error(error)}})),core__WEBPACK_IMPORTED_MODULE_0__.A.removeEventListener("documentLoaded",docLoadedEvent)}))}}};function prepareMultiTab(initialDoc,store){var _getHashParameters,extensions=null===(_getHashParameters=(0,helpers_getHashParameters__WEBPACK_IMPORTED_MODULE_6__.A)("extension",null))||void 0===_getHashParameters?void 0:_getHashParameters.split(",");if(extensions&&1!==extensions.length&&extensions.length!==initialDoc.length)throw new Error("'initialDoc' array length doesn't match 'extension' array length.\n          Please add an extension for each document or add one for all documents.\n          ex:\n          Webviewer({ initialDoc: ['pdf_doc', 'word_doc'], extension: ['pdf', 'docx'] })\n          OR\n          Webviewer({ initialDoc: ['pdf_doc1', 'pdf_doc2', 'pdf_doc3'], extension: ['pdf'] })");extensions&&1===extensions.length&&console.warn("Extension option '".concat(extensions[0],"' will be applied to all tabs from the constructor.")),store.dispatch(actions__WEBPACK_IMPORTED_MODULE_4__.A.setMultiTab(!0));var tabManager=new TabManager(initialDoc,extensions,store);store.dispatch(actions__WEBPACK_IMPORTED_MODULE_4__.A.setTabManager(tabManager)),tabManager.listenForAnnotChanges(),setTimeout((function(){(0,helpers_fireEvent__WEBPACK_IMPORTED_MODULE_7__.A)(constants_events__WEBPACK_IMPORTED_MODULE_9__.A.TAB_MANAGER_READY)}),300)}var _Symbol_iterator=Symbol.iterator,TabManager=function(){function TabManager(docArr,extensionArr,store){var _this=this;_class_call_check(this,TabManager),_define_property(this,"db",void 0),_define_property(this,"store",void 0),_define_property(this,"useDB",void 0),_define_property(this,"getViewerState",(function(state){var currentViewerState={},viewerState=state.viewer;return currentViewerState.documentContainerWidth=viewerState.documentContainerWidth,currentViewerState.documentContainerHeight=viewerState.documentContainerHeight,currentViewerState.isNotesPanelOpen=selectors__WEBPACK_IMPORTED_MODULE_5__.A.isElementOpen(state,"notesPanel"),currentViewerState.isLeftPanelOpen=selectors__WEBPACK_IMPORTED_MODULE_5__.A.isElementOpen(state,"leftPanel"),currentViewerState.isSearchPanelOpen=selectors__WEBPACK_IMPORTED_MODULE_5__.A.isElementOpen(state,"searchPanel"),currentViewerState.activeToolName=viewerState.activeToolName,currentViewerState}));var _ref,_this1=this;_define_property(this,"listenToDocumentDownloaded",(_ref=_async_to_generator((function(documentViewer){var _this_store_getState_viewer,tabs,activeTab,currentTab,onFileDownloaded,onPagesUpdated,removeListeners;return _ts_generator(this,(function(_state){return _this_store_getState_viewer=_this1.store.getState().viewer,tabs=_this_store_getState_viewer.tabs,activeTab=_this_store_getState_viewer.activeTab,currentTab=tabs.find((function(tab){return tab.id===activeTab})),onFileDownloaded=function(){currentTab.changes.hasUnsavedChanges=!1},onPagesUpdated=function(info){"refresh"!==info.source&&(currentTab.changes.hasUnsavedChanges=!0)},(0,helpers_getRootNode__WEBPACK_IMPORTED_MODULE_12__.Iv)().addEventListener(constants_events__WEBPACK_IMPORTED_MODULE_9__.A.FILE_DOWNLOADED,onFileDownloaded),documentViewer.addEventListener("pagesUpdated",onPagesUpdated),removeListeners=function(){(0,helpers_getRootNode__WEBPACK_IMPORTED_MODULE_12__.Iv)().removeEventListener(constants_events__WEBPACK_IMPORTED_MODULE_9__.A.FILE_DOWNLOADED,onFileDownloaded),documentViewer.removeEventListener("pagesUpdated",onPagesUpdated)},core__WEBPACK_IMPORTED_MODULE_0__.A.addEventListener("documentUnloaded",removeListeners,{once:!0}),[2]}))})),function(documentViewer){return _ref.apply(this,arguments)})),this.store=store;var state=this.store.getState();this.useDB=!state.advanced.disableIndexedDB;var _state_viewer=state.viewer,tabs=_state_viewer.tabs,isMultiTab=_state_viewer.isMultiTab;if(this.useDB){var req=indexedDB.open("WebViewer Files",1);req.onerror=TabManager.indexedDBNotSupported;var _this2=this;req.onsuccess=_async_to_generator((function(){return _ts_generator(this,(function(_state){return _this2.db=req.result,_this2.db.onerror=TabManager.throwError,[2]}))})),req.onupgradeneeded=function(e){e.target.result.createObjectStore("files")}}isMultiTab&&selectors__WEBPACK_IMPORTED_MODULE_5__.A.getTabManager(state)||(docArr.forEach((function(doc,index){var extension=extensionArr&&lodash_isString__WEBPACK_IMPORTED_MODULE_10___default()(doc)?extensionArr[extensionArr.length>1?index:0]:void 0,filename="Document ".concat(tabs.length+1);lodash_isString__WEBPACK_IMPORTED_MODULE_10___default()(doc)?filename=doc.substring(doc.lastIndexOf("/")+1):_instanceof(doc,window.Core.Document)&&doc.getFilename&&doc.getFilename()&&(filename=doc.getFilename()),tabs.push(new Tab(tabs.length,doc,_this,{filename,extension},_this.useDB))})),this.store.dispatch(actions__WEBPACK_IMPORTED_MODULE_4__.A.setTabs(tabs)),this.prepareTabEventListeners())}return _create_class(TabManager,[{key:"prepareTabEventListeners",value:function prepareTabEventListeners(){var _this=this,documentViewer=core__WEBPACK_IMPORTED_MODULE_0__.A.getDocumentViewer(1);documentViewer.addEventListener("finishedRendering",(function(){_this.listenForAnnotChanges(),_this.listenToDocumentDownloaded(documentViewer)}),{once:!0})}},{key:"setActiveTab",value:function setActiveTab(id){var saveCurrentActiveTabState=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],_this=this;return _async_to_generator((function(){var state,_state_viewer,tabs,activeTab,currentTab,isEmptyPageOpen,newTab;return _ts_generator(this,(function(_state){switch(_state.label){case 0:return _this.store.dispatch(actions__WEBPACK_IMPORTED_MODULE_4__.A.openElement(constants_dataElement__WEBPACK_IMPORTED_MODULE_11__.A.PROGRESS_MODAL)),_this.store.dispatch((0,actions_internalActions__WEBPACK_IMPORTED_MODULE_3__.setLoadingProgress)(0)),state=_this.store.getState(),_state_viewer=state.viewer,tabs=_state_viewer.tabs,activeTab=_state_viewer.activeTab,currentTab=tabs.find((function(tab){return tab.id===activeTab})),isEmptyPageOpen=selectors__WEBPACK_IMPORTED_MODULE_5__.A.isElementOpen(state,constants_dataElement__WEBPACK_IMPORTED_MODULE_11__.A.MULTITABS_EMPTY_PAGE),_this.prepareTabEventListeners(),(newTab=tabs.find((function(tab){return tab.id===id})))?currentTab?[4,core__WEBPACK_IMPORTED_MODULE_0__.A.getDocumentViewer().getAnnotationManager().exportAnnotations()]:[3,3]:[2,console.error("Tab id not found: ".concat(id))];case 1:return _state.sent(),[4,core__WEBPACK_IMPORTED_MODULE_0__.A.getDocumentViewer().getAnnotationsLoadedPromise()];case 2:_state.sent(),_state.label=3;case 3:return(0,helpers_fireEvent__WEBPACK_IMPORTED_MODULE_7__.A)(constants_events__WEBPACK_IMPORTED_MODULE_9__.A.BEFORE_TAB_CHANGED,{currentTab:currentTab?{src:currentTab.src,options:currentTab.options,id:currentTab.id,annotationsChanged:currentTab.changes.annotations,hasUnsavedChanges:currentTab.changes.hasUnsavedChanges}:null,nextTab:{src:newTab.src,options:newTab.options,id:newTab.id}}),setTimeout(_async_to_generator((function(){return _ts_generator(this,(function(_state){switch(_state.label){case 0:return currentTab?saveCurrentActiveTabState?[4,currentTab.saveCurrentActiveTabState(_this.db)]:[3,2]:[3,3];case 1:_state.sent(),_state.label=2;case 2:core__WEBPACK_IMPORTED_MODULE_0__.A.closeDocument(),_state.label=3;case 3:return _this.store.dispatch(actions__WEBPACK_IMPORTED_MODULE_4__.A.setActiveTab(id)),isEmptyPageOpen&&_this.store.dispatch(actions__WEBPACK_IMPORTED_MODULE_4__.A.closeElement(constants_dataElement__WEBPACK_IMPORTED_MODULE_11__.A.MULTITABS_EMPTY_PAGE)),[4,newTab.load(_this.store.dispatch,_this.db,_this.getViewerState(state))];case 4:return _state.sent(),[2]}}))})),400),[2]}}))}))()}},{key:"showDeleteWarning",value:function showDeleteWarning(tabToDelete){var _this=this,confirmationWarning={message:"warning.closeFile.message",title:"warning.closeFile.title",onConfirm:function(){(0,helpers_downloadPdf__WEBPACK_IMPORTED_MODULE_8__.A)(_this.store.dispatch).then((function(){tabToDelete.changes.hasUnsavedChanges=!1,_this.deleteTab(tabToDelete.id)}))},onSecondary:function(){tabToDelete.changes.hasUnsavedChanges=!1,_this.deleteTab(tabToDelete.id)},confirmBtnText:"action.download",secondaryBtnText:"warning.closeFile.rejectDownloadButton",secondaryBtnClass:"secondary-btn-custom",showAskAgainCheckbox:!0,onClose:function(disableWarning){disableWarning&&_this.store.dispatch(actions__WEBPACK_IMPORTED_MODULE_4__.A.disableDeleteTabWarning())}};this.store.dispatch(actions__WEBPACK_IMPORTED_MODULE_4__.A.showWarningMessage(confirmationWarning))}},{key:"deleteTab",value:function deleteTab(id){var state=this.store.getState(),_state_viewer=state.viewer,tabs=_state_viewer.tabs,activeTab=_state_viewer.activeTab,tabToDelete=tabs.find((function(tab){return tab.id===id}));if(selectors__WEBPACK_IMPORTED_MODULE_5__.A.getShowDeleteTabWarning(state)&&tabToDelete.changes.hasUnsavedChanges)this.showDeleteWarning(tabToDelete);else{var deletedTab=_sliced_to_array(tabs.splice(tabs.findIndex((function(tab){return tab.id===id})),1),1)[0];deletedTab.delete(this.db),(0,helpers_fireEvent__WEBPACK_IMPORTED_MODULE_7__.A)(constants_events__WEBPACK_IMPORTED_MODULE_9__.A.TAB_DELETED,{src:deletedTab.src,options:deletedTab.options,id:deletedTab.id}),id===activeTab&&tabs.length?this.setActiveTab(tabs[0].id):tabs.length||(core__WEBPACK_IMPORTED_MODULE_0__.A.closeDocument(),this.store.dispatch(actions__WEBPACK_IMPORTED_MODULE_4__.A.setActiveTab(null))),this.store.dispatch(actions__WEBPACK_IMPORTED_MODULE_4__.A.setTabs(tabs))}}},{key:"addTab",value:function addTab(src){var options=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},_this=this;return _async_to_generator((function(){var saveCurrentTabState,useDB,shouldLoadTab,tabs,currId,tab;return _ts_generator(this,(function(_state){switch(_state.label){case 0:return saveCurrentTabState=options.saveCurrentActiveTabState||options.saveCurrent,useDB=!1===options.useDB?options.useDB&&_this.useDB:_this.useDB,shouldLoadTab=options.setActive||options.load,tabs=_this.store.getState().viewer.tabs,currId=tabs.reduce((function(highestId,tab){return tab.id>highestId?tab.id:highestId}),0),"filename"in options||(options.filename="Document ".concat(currId+2),lodash_isString__WEBPACK_IMPORTED_MODULE_10___default()(src)?options.filename=src.substring(src.lastIndexOf("/")+1):_instanceof(src,window.Core.Document)&&src.getFilename&&src.getFilename()?options.filename=src.getFilename():(_instanceof(src,File)||"[object File]"===Object.prototype.toString.call(src))&&(options.filename=src.name)),tab=new Tab(currId+1,src,_this,options,useDB),tabs.push(tab),(0,helpers_fireEvent__WEBPACK_IMPORTED_MODULE_7__.A)(constants_events__WEBPACK_IMPORTED_MODULE_9__.A.TAB_ADDED,{src:tab.src,options:tab.options,id:tab.id}),shouldLoadTab?[4,_this.setActiveTab(tab.id,saveCurrentTabState)]:[3,2];case 1:_state.sent(),_state.label=2;case 2:return _this.store.dispatch(actions__WEBPACK_IMPORTED_MODULE_4__.A.setTabs(tabs)),[2,tab.id]}}))}))()}},{key:"moveTab",value:function moveTab(from,to){var tabs=this.store.getState().viewer.tabs,tab=tabs.splice(from,1)[0];tabs.splice(to,0,tab),(0,helpers_fireEvent__WEBPACK_IMPORTED_MODULE_7__.A)(constants_events__WEBPACK_IMPORTED_MODULE_9__.A.TAB_MOVED,{src:tab.src,options:tab.options,id:tab.id,prevIndex:from,newIndex:to}),this.store.dispatch(actions__WEBPACK_IMPORTED_MODULE_4__.A.setTabs(tabs))}},{key:"listenForAnnotChanges",value:function listenForAnnotChanges(){var _this=this,onAnnotChange=function(_,__,info){if(!info.imported){var _this_store_getState_viewer=_this.store.getState().viewer,tabs=_this_store_getState_viewer.tabs,activeTab=_this_store_getState_viewer.activeTab,tab=tabs.find((function(t){return t.id===activeTab}));tab&&(tab.changes.annotations=!0,tab.changes.hasUnsavedChanges=!0),removeListeners()}},onFieldChange=function(){var _this_store_getState_viewer=_this.store.getState().viewer,tabs=_this_store_getState_viewer.tabs,activeTab=_this_store_getState_viewer.activeTab,tab=tabs.find((function(t){return t.id===activeTab}));tab&&(tab.changes.annotations=!0,tab.changes.hasUnsavedChanges=!0),removeListeners()};core__WEBPACK_IMPORTED_MODULE_0__.A.addEventListener("annotationChanged",onAnnotChange),core__WEBPACK_IMPORTED_MODULE_0__.A.addEventListener("fieldChanged",onFieldChange,{once:!0});var removeListeners=function(){core__WEBPACK_IMPORTED_MODULE_0__.A.removeEventListener("annotationChanged",onAnnotChange),core__WEBPACK_IMPORTED_MODULE_0__.A.removeEventListener("fieldChanged",onFieldChange)};core__WEBPACK_IMPORTED_MODULE_0__.A.addEventListener("documentUnloaded",removeListeners,{once:!0})}},{key:_Symbol_iterator,value:function value(){var tabs,_iteratorNormalCompletion,_didIteratorError,_iteratorError,_iterator,_step,err;return _ts_generator(this,(function(_state){switch(_state.label){case 0:tabs=this.store.getState().viewer.tabs,_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0,_state.label=1;case 1:_state.trys.push([1,6,7,8]),_iterator=tabs[Symbol.iterator](),_state.label=2;case 2:return(_iteratorNormalCompletion=(_step=_iterator.next()).done)?[3,5]:[4,_step.value];case 3:_state.sent(),_state.label=4;case 4:return _iteratorNormalCompletion=!0,[3,2];case 5:return[3,8];case 6:return err=_state.sent(),_didIteratorError=!0,_iteratorError=err,[3,8];case 7:try{_iteratorNormalCompletion||null==_iterator.return||_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}return[7];case 8:return[2]}}))}},{key:"map",value:function map(cb){var mapped=[],index=0,tabs=this.store.getState().viewer.tabs,_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=tabs[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var tab=_step.value;mapped.push(cb(tab,index++))}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{_iteratorNormalCompletion||null==_iterator.return||_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return mapped}}],[{key:"throwError",value:function throwError(){console.warn("File database has encountered an error. File data will not be saved when switching tabs")}},{key:"indexedDBNotSupported",value:function indexedDBNotSupported(){console.warn("IndexedDB is not supported, file data will not be saved")}}]),TabManager}();_define_property(TabManager,"MAX_FILE_SIZE",25e7);var Tab=function(){function Tab(id,src,tabManager){var options=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},useDB=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];_class_call_check(this,Tab),_define_property(this,"disabled",!1),_define_property(this,"saveData",{annotInDB:!1,docInDB:!1,scrollTop:void 0,scrollLeft:void 0,page:null,annots:null}),_define_property(this,"changes",{annotations:!1,hasUnsavedChanges:!1}),_define_property(this,"id",void 0),_define_property(this,"src",void 0),_define_property(this,"options",void 0),_define_property(this,"useDB",void 0),_define_property(this,"tabManager",void 0),this.id=id,this.src=src,this.options=options,this.useDB=useDB,this.tabManager=tabManager}return _create_class(Tab,[{key:"preLoad",value:function preLoad(db){var _this=this;return _async_to_generator((function(){var file,_,_tmp;return _ts_generator(this,(function(_state){switch(_state.label){case 0:return _this.useDB?[4,fetch(_this.src)]:[2,console.error("Cant preload tab with useDB = false")];case 1:return file=_state.sent(),_=_this.writeToDB,_tmp=[db],[4,file.arrayBuffer()];case 2:return[4,_.apply(_this,_tmp.concat([_state.sent()]))];case 3:return _state.sent(),[2]}}))}))()}},{key:"load",value:function load(dispatch,db,viewerState){var _this=this;return _async_to_generator((function(){var annotsChanged,tx,store,req;return _ts_generator(this,(function(_state){return annotsChanged=_this.saveData.annotInDB||_this.saveData.annots,_this.options.loadAnnotations=!annotsChanged,core__WEBPACK_IMPORTED_MODULE_0__.A.addEventListener("documentUnloaded",_async_to_generator((function(){return _ts_generator(this,(function(_state){switch(_state.label){case 0:return _this.restorePageDataOnLoad(viewerState,dispatch),annotsChanged?[4,_this.restoreAnnotDataOnLoad(db)]:[3,2];case 1:_state.sent(),_state.label=2;case 2:return[2]}}))})),{once:!0}),_this.useDB&&_this.saveData.docInDB?(tx=db.transaction("files","readonly"),store=tx.objectStore("files"),(req=store.get(_this.id)).onsuccess=_async_to_generator((function(){var doc;return _ts_generator(this,(function(_state){return doc=req.result,(0,helpers_loadDocument__WEBPACK_IMPORTED_MODULE_2__.A)(dispatch,doc,_this.options),[2]}))})),tx.commit()):(0,helpers_loadDocument__WEBPACK_IMPORTED_MODULE_2__.A)(dispatch,_this.src,_this.options),[2]}))}))()}},{key:"saveCurrentActiveTabState",value:function saveCurrentActiveTabState(db){var _this=this;return _async_to_generator((function(){var document;return _ts_generator(this,(function(_state){switch(_state.label){case 0:return _this.disabled=!0,_this.savePageData(),document=core__WEBPACK_IMPORTED_MODULE_0__.A.getDocument(),_this.useDB&&((null==document?void 0:document.type)===constants_types__WEBPACK_IMPORTED_MODULE_1__._.PDF&&document.arePagesAltered()||_instanceof(_this.src,window.Core.Document))?[4,_this.saveFileData(db,document)]:[3,2];case 1:return _state.sent(),[3,6];case 2:return _this.changes.annotations?_this.useDB?[4,_this.saveAnnotDataInDB(db)]:[3,4]:[3,6];case 3:return _state.sent(),[3,6];case 4:return[4,_this.saveAnnotData()];case 5:_state.sent(),_state.label=6;case 6:return _this.disabled=!1,[2]}}))}))()}},{key:"saveFileData",value:function saveFileData(db,document){var _this=this;return _async_to_generator((function(){var xfdfString,data;return _ts_generator(this,(function(_state){switch(_state.label){case 0:return _this.saveData.annotInDB=!1,[4,core__WEBPACK_IMPORTED_MODULE_0__.A.exportAnnotations()];case 1:return xfdfString=_state.sent(),[4,document.getFileData({xfdfString,flags:window.Core.SaveOptions.LINEARIZED,finishedWithDocument:!0})];case 2:return data=_state.sent(),[4,_this.writeToDB(db,data)];case 3:return _state.sent(),[2]}}))}))()}},{key:"saveAnnotData",value:function saveAnnotData(){var _this=this;return _async_to_generator((function(){var annotData;return _ts_generator(this,(function(_state){switch(_state.label){case 0:return _this.saveData.annotInDB=!1,[4,core__WEBPACK_IMPORTED_MODULE_0__.A.exportAnnotations({options:{fields:!0,widgets:!0,links:!0}})];case 1:return(annotData=_state.sent())&&(_this.saveData.annots=annotData),[2]}}))}))()}},{key:"saveAnnotDataInDB",value:function saveAnnotDataInDB(db){var _this=this;return _async_to_generator((function(){var annotData,annots,tx;return _ts_generator(this,(function(_state){switch(_state.label){case 0:return[4,core__WEBPACK_IMPORTED_MODULE_0__.A.exportAnnotations({options:{fields:!0,widgets:!0,links:!0}})];case 1:return(annotData=_state.sent())?(annots=annotData,tx=db.transaction("files","readwrite"),tx.objectStore("files").put(annots,"".concat(_this.id,"-annots")),[4,tx.commit()]):[3,3];case 2:_state.sent(),_this.saveData.annotInDB=!0,_state.label=3;case 3:return[2]}}))}))()}},{key:"savePageData",value:function savePageData(){var docContainer=(0,helpers_getRootNode__WEBPACK_IMPORTED_MODULE_12__.Ay)().getElementById("app").getElementsByClassName("DocumentContainer")[0];this.saveData.scrollTop=docContainer.scrollTop,this.saveData.scrollLeft=docContainer.scrollLeft,this.saveData.page=core__WEBPACK_IMPORTED_MODULE_0__.A.getCurrentPage();this.saveData.zoom=Math.floor(1e4*core__WEBPACK_IMPORTED_MODULE_0__.A.getZoom())/1e4}},{key:"restorePageDataOnLoad",value:function restorePageDataOnLoad(viewerState,dispatch){var _ref,docContainer=(0,helpers_getRootNode__WEBPACK_IMPORTED_MODULE_12__.Ay)().getElementById("app").getElementsByClassName("DocumentContainer")[0],_this=this,updateScroll=(_ref=_async_to_generator((function(){return _ts_generator(this,(function(_state){switch(_state.label){case 0:return[4,core__WEBPACK_IMPORTED_MODULE_0__.A.getDocument().getDocumentCompletePromise()];case 1:return _state.sent(),docContainer.scrollTo({top:_this.saveData.scrollTop,left:_this.saveData.scrollLeft}),[2]}}))})),function updateScroll(){return _ref.apply(this,arguments)});viewerState.isNotesPanelOpen&&dispatch(actions__WEBPACK_IMPORTED_MODULE_4__.A.openElement("notesPanel")),viewerState.isLeftPanelOpen&&dispatch(actions__WEBPACK_IMPORTED_MODULE_4__.A.openElement("leftPanel")),viewerState.isSearchPanelOpen&&dispatch(actions__WEBPACK_IMPORTED_MODULE_4__.A.openElement("searchPanel")),viewerState.activeToolName&&core__WEBPACK_IMPORTED_MODULE_0__.A.setToolMode(viewerState.activeToolName);var _this1=this,updateViewer=function(){var _ref=_async_to_generator((function(){return _ts_generator(this,(function(_state){switch(_state.label){case 0:return[4,core__WEBPACK_IMPORTED_MODULE_0__.A.getDocument().getDocumentCompletePromise()];case 1:return _state.sent(),_this1.saveData.zoom?[4,core__WEBPACK_IMPORTED_MODULE_0__.A.zoomTo(_this1.saveData.zoom)]:[3,3];case 2:_state.sent(),_state.label=3;case 3:return _this1.saveData.page?[4,core__WEBPACK_IMPORTED_MODULE_0__.A.setCurrentPage(_this1.saveData.page)]:[3,5];case 4:_state.sent(),_state.label=5;case 5:return[2]}}))}));return function updateViewer(){return _ref.apply(this,arguments)}}();core__WEBPACK_IMPORTED_MODULE_0__.A.addEventListener("documentLoaded",updateViewer,{once:!0}),!isNaN(this.saveData.scrollTop)&&core__WEBPACK_IMPORTED_MODULE_0__.A.addEventListener("finishedRendering",updateScroll,{once:!0});core__WEBPACK_IMPORTED_MODULE_0__.A.addEventListener("documentUnloaded",(function(){core__WEBPACK_IMPORTED_MODULE_0__.A.removeEventListener("documentLoaded",updateViewer),core__WEBPACK_IMPORTED_MODULE_0__.A.removeEventListener("finishedRendering",updateScroll)}),{once:!0})}},{key:"updateAnnotations",value:function updateAnnotations(db){var _this=this;return _async_to_generator((function(){var state,activeTabId,tx,store,annotReq;return _ts_generator(this,(function(_state){switch(_state.label){case 0:return state=_this.tabManager.store.getState(),(activeTabId=selectors__WEBPACK_IMPORTED_MODULE_5__.A.getActiveTab(state))!==_this.id?[2,selectors__WEBPACK_IMPORTED_MODULE_5__.A.getTabs(state).find((function(tab){return tab.id===activeTabId})).updateAnnotations(db)]:_this.saveData.annotInDB?(tx=db.transaction("files","readwrite"),store=tx.objectStore("files"),(annotReq=store.get("".concat(_this.id,"-annots"))).onsuccess=_async_to_generator((function(){return _ts_generator(this,(function(_state){switch(_state.label){case 0:return[4,core__WEBPACK_IMPORTED_MODULE_0__.A.getDocument().getDocumentCompletePromise()];case 1:return _state.sent(),[4,core__WEBPACK_IMPORTED_MODULE_0__.A.getAnnotationManager().importAnnotations(annotReq.result)];case 2:return _state.sent(),[2]}}))})),[4,tx.commit()]):[3,2];case 1:return _state.sent(),[3,5];case 2:return _this.saveData.annots?[4,core__WEBPACK_IMPORTED_MODULE_0__.A.getDocument().getDocumentCompletePromise()]:[3,5];case 3:return _state.sent(),[4,core__WEBPACK_IMPORTED_MODULE_0__.A.getAnnotationManager().importAnnotations(_this.saveData.annots)];case 4:_state.sent(),_state.label=5;case 5:return[2]}}))}))()}},{key:"restoreAnnotDataOnLoad",value:function restoreAnnotDataOnLoad(db){var _this=this;return _async_to_generator((function(){var updateAnnotations,removeListeners;return _ts_generator(this,(function(_state){return updateAnnotations=function(){return _this.updateAnnotations(db)},removeListeners=function(){core__WEBPACK_IMPORTED_MODULE_0__.A.removeEventListener("documentLoaded",updateAnnotations)},core__WEBPACK_IMPORTED_MODULE_0__.A.addEventListener("documentLoaded",updateAnnotations,{once:!0}),core__WEBPACK_IMPORTED_MODULE_0__.A.addEventListener("documentUnloaded",removeListeners,{once:!0}),[2]}))}))()}},{key:"writeToDB",value:function writeToDB(db,arrBuff){var _this=this;return _async_to_generator((function(){var tx;return _ts_generator(this,(function(_state){switch(_state.label){case 0:return tx=db.transaction("files","readwrite"),tx.objectStore("files").put(arrBuff,_this.id),_this.saveData.docInDB=!0,[4,tx.commit()];case 1:return _state.sent(),[2]}}))}))()}},{key:"delete",value:function _delete(db){var _this=this;return _async_to_generator((function(){var tx,store;return _ts_generator(this,(function(_state){switch(_state.label){case 0:return _this.useDB?(tx=db.transaction("files","readwrite"),(store=tx.objectStore("files")).delete(_this.id),store.delete("".concat(_this.id,"-annot-states")),store.delete("".concat(_this.id,"-annots")),[4,tx.commit()]):[3,2];case 1:_state.sent(),_state.label=2;case 2:return[2]}}))}))()}}]),Tab}()}}]);